---
# These are optional elements. Feel free to remove any of them.
status: proposed
date: 2023-05-29
deciders: @rogerbarreto, @shawncal, @stephentoub
consulted: 
informed: 
---

# ISKFunctions Hooks - Notification

## Context and Problem Statement

An ISKFunction Caller needs:

- Know and be notified before the ISKFunction is executed by either `Function.InvokeAsync` or `Kernel.RunAsync` with information it can get prior and after execution.

  - Pre-Execution

    - Get: Prompt generated by the current Kernel `TemplateEngine` before calling the LLM
    - Get: Current settings used
    - Get: Parameters used
    - Get: SKContext
    - Set: Modify a prompt content before sending it to LLM
    - Set: Abort/Cancel function execution

  - In-Execution / Stream Processing

    - Get: Text Prompt generated per stream block `IAsyncEnumerable<string>`
    - Set: Filter/Change a prompt stream block
    - Set: Skip a prompt stream block

  - Post-Execution

    - Get: LLM Model Result (Tokens Usage, Stop Sequence, ...)
    - Get: Generated Prompt
    - Get: SKContext
    - Get: Output parameters

    - Set: Modify a prompt content after getting it from LLM and before reading it into SKContext.Variables

    - Set: Modify output parameters content

## Decision Drivers

- Architecture changes and the associated decision making process should be transparent to the community.
- Decision records are stored in the repository and are easily discoverable for teams involved in the various language ports.

## Considered Options

- Event Based Registration: Expose events on both IKernel and ISKFunction that the call can can be observing to interact.
- Callback (Kernel and Function)

  - Specified on kernel level as a configuration be able to specify what are the callback hooks that will be triggered.
  - Specified on function creation: As part of the function constructor be able to specify what are the callback hooks that will be triggered.
  - Specified on function invocation: As part of the function invoke be able to specify what are the callback hooks as a parameter that will be triggered.

- Middleware ?
  - Specified on Kernel level, and would only be used using IKernel.RunAsync operation, this pattern would be similar to asp.net core middlewares, running the pipelines with a context and a requestdelegate next for controlling (Pre/Post conditions)

## Pros and Cons of the Options

### Event Base Registration

Pros: - Multiple Listeners can register for the same event - The be registered and unregistered at will
Cons: - Unconventional approach for libraries - Not clear how supportive is this approach for asynchronous pattern/multi threading

### Callback Delegate

Pros: - Common pattern for observing and also changing data exposed as parameter into the delegate signature for (Get/Set) scenarios
Cons: - Limited to only one method observing a specific event (Pre Post and InExecution). - Function When used as parameter, three new parameters would be needed as part of the function. (Specified on function invocation) - Extra Cons on

### Middleware

Pros: - Common pattern for handling Pre/Post Setting/Filtering data

Cons:
0

## Open Questions

- Post Execution Hooks should execute right after the LLM result or before the end of the function execution itself?

- Setting hooks on top of pre existing hooks should be allowed or throw an error?

- Setting hooks on Plans should automatically cascade this hooks for all the inner steps + overriding existing ones in the process?

- Should we have dedicated method to Set Hooks for all its children steps (working recursively)?

- Pre/Post function Hooks should be one or many (pub/sub) allowing naming/deregistration?

## Decision Outcome

TBD.
